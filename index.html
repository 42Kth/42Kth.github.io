<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard ท่องศัพท์ - Spaced Repetition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5;
        }
        .flip-card {
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flip-card-back {
            transform: rotateY(180deg);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 max-w-2xl min-h-screen flex flex-col justify-center items-center">
        
        <!-- Loading Screen -->
        <div id="loading-view" class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            <p class="mt-4 text-lg">กำลังเตรียมข้อมูล...</p>
        </div>

        <!-- Login View -->
        <div id="login-view" class="hidden w-full text-center bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold mb-2 text-blue-600">Flashcard ท่องศัพท์</h1>
            <p class="text-gray-600 mb-8">ใช้เทคนิค Spaced Repetition เพื่อการจดจำที่ดีที่สุด</p>
            <button id="line-login-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg w-full max-w-xs mx-auto flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14.2 2H9.8C5.4 2 2 5.4 2 9.8v4.4c0 4.4 3.4 7.8 7.8 7.8h.4c.5 0 .9.3 1 .8l.4 1.7c.2.8 1 1.3 1.8 1.3h.4c.8 0 1.6-.5 1.8-1.3l.4-1.7c.1-.5.5-.8 1-.8h.4c4.4 0 7.8-3.4 7.8-7.8V9.8C22 5.4 18.6 2 14.2 2zM8.5 13.5c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm7 0c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm-3-2.5c-.6 0-1-.4-1-1V8.5c0-.6.4-1 1-1s1 .4 1 1V10c0 .6-.4 1-1 1z"/></svg>
                <span>เข้าสู่ระบบด้วย LINE</span>
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden w-full space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                <img id="profile-pic" src="https://placehold.co/80x80/EFEFEF/AAAAAA?text=User" class="w-20 h-20 rounded-full border-4 border-blue-200">
                <div>
                    <h2 class="text-2xl font-bold" id="display-name">สวัสดี, !</h2>
                    <p class="text-gray-500">ยินดีต้อนรับกลับมา</p>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">สถิติการเรียนรู้</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-3xl font-bold text-blue-600" id="total-learned">0</p>
                        <p class="text-gray-500">คำที่เรียนแล้ว</p>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-green-600" id="due-for-review">0</p>
                        <p class="text-gray-500">คำที่ต้องทบทวน</p>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-yellow-600" id="total-cards">0</p>
                        <p class="text-gray-500">คำศัพท์ทั้งหมด</p>
                    </div>
                </div>
            </div>

            <button id="start-game-btn" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-xl">
                เริ่มท่องศัพท์
            </button>
        </div>

        <!-- Setup View -->
        <div id="setup-view" class="hidden w-full text-center bg-white p-8 rounded-2xl shadow-lg space-y-6">
            <h2 class="text-3xl font-bold">ตั้งค่าการเรียน</h2>
            <p class="text-gray-600">เลือกจำนวนคำศัพท์ใหม่ที่ต้องการเรียนในรอบนี้</p>
            <div>
                <input type="number" id="card-count-input" value="10" min="1" max="50" class="text-center text-xl p-3 w-40 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <p class="text-sm text-gray-500 mt-2">แนะนำ 10-20 คำต่อวัน</p>
            </div>
            <button id="start-session-btn" class="btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg">เริ่มเลย!</button>
             <button id="back-to-dashboard-btn" class="w-full text-gray-600 font-medium py-2 px-6 rounded-lg mt-2">กลับไปหน้าหลัก</button>
        </div>

        <!-- Game View -->
        <div id="game-view" class="hidden w-full flex flex-col items-center space-y-6">
            <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-gray-600 font-medium"></p>
            
            <div id="flashcard" class="flip-card w-full h-64 sm:h-80 cursor-pointer">
                <div class="flip-card-inner">
                    <div id="card-front" class="flip-card-front bg-white p-4">
                        <!-- Content injected by JS -->
                    </div>
                    <div id="card-back" class="flip-card-back bg-blue-50 p-4">
                        <!-- Content injected by JS -->
                    </div>
                </div>
            </div>

            <div id="answer-buttons" class="hidden w-full grid grid-cols-2 gap-4 pt-4">
                <button id="forgot-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg text-lg">จำไม่ได้</button>
                <button id="remembered-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg text-lg">จำได้</button>
            </div>
        </div>

        <!-- Session Complete View -->
        <div id="session-complete-view" class="hidden w-full text-center bg-white p-8 rounded-2xl shadow-lg space-y-4">
            <h2 class="text-3xl font-bold text-green-600">เยี่ยมมาก!</h2>
            <p class="text-gray-700 text-lg">คุณเรียนจบรอบนี้แล้ว</p>
            <p id="session-summary" class="text-gray-500"></p>
            <button id="finish-session-btn" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg mt-4">กลับไปหน้าหลัก</button>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        // !!! สำคัญ: กรุณาเปลี่ยนค่านี้เป็น LIFF ID ของคุณที่ได้จาก LINE Developers Console
        // ข้อผิดพลาด "LIFF app not found" หรือ "channel not found" หมายความว่า LIFF ID นี้ไม่ถูกต้อง
        // หรือ Channel ที่ LIFF ID นี้สังกัดอยู่มีการตั้งค่าที่ผิดพลาด
        // คุณต้องนำ LIFF ID ที่ถูกต้องจาก Channel ของคุณใน LINE Developers Console มาใส่ที่นี่
        const LIFF_ID = "2008163328-MJ8PYBW7"; 
        
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1OYlmrA3-8pPJRa4BSauFeNh3EvxVJJJw3QTQ-q_cSqY/gviz/tq?tqx=out:csv&sheet=Sheet1';

        // --- DOM ELEMENTS ---
        const views = {
            loading: document.getElementById('loading-view'),
            login: document.getElementById('login-view'),
            dashboard: document.getElementById('dashboard-view'),
            setup: document.getElementById('setup-view'),
            game: document.getElementById('game-view'),
            sessionComplete: document.getElementById('session-complete-view')
        };
        const lineLoginBtn = document.getElementById('line-login-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const startSessionBtn = document.getElementById('start-session-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const finishSessionBtn = document.getElementById('finish-session-btn');
        const cardCountInput = document.getElementById('card-count-input');
        const flashcard = document.getElementById('flashcard');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const answerButtons = document.getElementById('answer-buttons');
        const forgotBtn = document.getElementById('forgot-btn');
        const rememberedBtn = document.getElementById('remembered-btn');

        // --- APP STATE ---
        let allCards = [];
        let userProfile = null;
        let userProgress = {}; // { cardId: { level: 0, dueDate: 'YYYY-MM-DDTHH:mm:ss.sssZ' } }
        let session = {
            queue: [],
            totalInSession: 0,
            newCardsStudied: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
        };
        
        // --- Spaced Repetition Intervals (in minutes) ---
        const SRS_INTERVALS = [10, 60, 6 * 60, 24 * 60, 3 * 24 * 60, 7 * 24 * 60, 2 * 7 * 24 * 60, 30 * 24 * 60];

        // --- FUNCTIONS ---
        const showView = (viewName) => {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
        };

        const initializeLiff = async () => {
            try {
                if (LIFF_ID === "YOUR_LIFF_ID_HERE") {
                    throw new Error("LIFF ID is not set. Please configure it in the script.");
                }
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    userProfile = await liff.getProfile();
                    await loadDataAndSetupDashboard();
                } else {
                    showView('login');
                }
            } catch (error) {
                console.error("LIFF Initialization failed:", error);
                const loginView = views.login;
                let errorMessage = `เกิดข้อผิดพลาดในการเชื่อมต่อกับ LINE: <br><b>${error.message}</b>.`;

                if (error.message.toLowerCase().includes("channel not found")) {
                    errorMessage += '<br><div class="text-left mt-2 p-3 bg-red-50 rounded-lg"><strong>ข้อผิดพลาดนี้หมายถึง Channel ที่ LIFF ID สังกัดอยู่มีปัญหา</strong><br>กรุณาตรวจสอบใน LINE Developers Console ว่า: <br>1. Channel ของคุณยังเปิดใช้งานอยู่ (Published) <br>2. LIFF ID ถูกต้องและอยู่ใน Channel ที่ถูกต้อง</div>';
                } else if (error.message.toLowerCase().includes("liff app not found")) {
                     errorMessage += '<br><div class="text-left mt-2 p-3 bg-red-50 rounded-lg"><strong>กรุณาตรวจสอบว่า LIFF ID ที่ใส่ในโค้ดถูกต้องหรือไม่</strong></div>';
                } else if (error.message.toLowerCase().includes("liff id is not set")) {
                    errorMessage = '<b>กรุณาตั้งค่า LIFF_ID ในไฟล์โค้ด (index.html) ก่อนใช้งาน</b>';
                }
                
                const existingError = loginView.querySelector('.error-message');
                if (existingError) {
                    existingError.innerHTML = errorMessage;
                } else {
                    loginView.insertAdjacentHTML('beforeend', `<div class="error-message text-red-600 mt-4">${errorMessage}</div>`);
                }

                showView('login');
            }
        };

        const loadGoogleSheetData = async () => {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const rows = csvText.trim().split('\n').slice(1);
                allCards = rows.map((row, index) => {
                    const columns = row.split(',').map(col => col.trim().replace(/"/g, ''));
                    return {
                        id: `card_${index}`,
                        word: columns[0] || '',
                        partOfSpeech: columns[1] || '',
                        thai: columns[2] || '',
                        eng: columns[3] || '',
                    };
                }).filter(card => card.word); 
            } catch (error) {
                console.error("Failed to load Google Sheet data:", error);
                alert("ไม่สามารถโหลดข้อมูลคำศัพท์ได้ กรุณาตรวจสอบว่า URL ของ Google Sheet ถูกต้องและเปิดเป็นสาธารณะ");
            }
        };

        const loadUserProgress = () => {
            try {
                const savedProgress = localStorage.getItem(`srs_progress_${userProfile.userId}`);
                userProgress = savedProgress ? JSON.parse(savedProgress) : {};
            } catch (e) {
                console.error("Failed to parse user progress from localStorage", e);
                userProgress = {};
            }
        };

        const saveUserProgress = () => {
            try {
                localStorage.setItem(`srs_progress_${userProfile.userId}`, JSON.stringify(userProgress));
            } catch (e) {
                console.error("Failed to save user progress to localStorage", e);
            }
        };

        const updateDashboard = () => {
            document.getElementById('profile-pic').src = userProfile.pictureUrl || 'https://placehold.co/80x80/EFEFEF/AAAAAA?text=User';
            document.getElementById('display-name').textContent = `สวัสดี, ${userProfile.displayName}`;
            
            const now = new Date();
            const dueCards = Object.values(userProgress).filter(p => p.dueDate && new Date(p.dueDate) <= now);
            
            document.getElementById('total-learned').textContent = Object.keys(userProgress).length;
            document.getElementById('due-for-review').textContent = dueCards.length;
            document.getElementById('total-cards').textContent = allCards.length;
        };
        
        const loadDataAndSetupDashboard = async () => {
            showView('loading');
            await loadGoogleSheetData();
            if (userProfile) {
                loadUserProgress();
                updateDashboard();
                showView('dashboard');
            } else {
                showView('login'); 
            }
        };

        const createSession = (newCardCount) => {
            const now = new Date();
            const dueCardsIds = Object.keys(userProgress).filter(id => {
                const progress = userProgress[id];
                return progress && progress.dueDate && new Date(progress.dueDate) <= now;
            });
            
            const newCards = allCards.filter(card => !userProgress[card.id]);
            const newCardsForSessionIds = newCards.slice(0, newCardCount).map(c => c.id);
            
            session.queue = [...dueCardsIds, ...newCardsForSessionIds]
                .sort(() => Math.random() - 0.5);

            session.totalInSession = session.queue.length;
            session.newCardsStudied = 0;
            session.correctAnswers = 0;
            session.incorrectAnswers = 0;

            if (session.queue.length > 0) {
                showView('game');
                nextCard();
            } else {
                alert("ไม่มีการ์ดให้ทบทวนหรือเรียนในตอนนี้ ลองเพิ่มจำนวนการ์ดใหม่ดูนะ!");
            }
        };

        const nextCard = () => {
            flashcard.classList.remove('flipped');
            answerButtons.classList.add('hidden');

            setTimeout(() => {
                if (session.queue.length === 0) {
                    showSessionComplete();
                    return;
                }

                const cardId = session.queue[0];
                const card = allCards.find(c => c.id === cardId);

                if (!card) {
                    console.error(`Card not found for id: ${cardId}. Skipping.`);
                    session.queue.shift(); 
                    nextCard(); 
                    return;
                }
                
                session.queue.shift(); 
                
                cardFront.innerHTML = `
                    <h2 class="text-4xl md:text-5xl font-bold text-center">${card.word}</h2>
                    <p class="text-xl text-gray-500 mt-2">${card.partOfSpeech}</p>
                `;
                cardBack.innerHTML = `
                    <div class="text-center space-y-4">
                        <div>
                            <p class="text-sm font-semibold text-blue-800">คำแปล (ไทย)</p>
                            <p class="text-2xl">${card.thai}</p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-800">ความหมาย (Eng)</p>
                            <p class="text-lg">${card.eng}</p>
                        </div>
                    </div>
                `;

                flashcard.dataset.cardId = card.id;

                const completedCount = session.totalInSession - session.queue.length;
                const progress = session.totalInSession > 0 ? (completedCount / session.totalInSession) * 100 : 0;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `คำที่ ${completedCount} / ${session.totalInSession}`;
            }, 300); 
        };

        const handleAnswer = (remembered) => {
            const cardId = flashcard.dataset.cardId;
            let progress = userProgress[cardId];

            if (!progress) {
                progress = { level: 0, dueDate: new Date().toISOString() };
                session.newCardsStudied++;
            }

            if (remembered) {
                session.correctAnswers++;
                progress.level = Math.min(progress.level + 1, SRS_INTERVALS.length - 1);
            } else {
                session.incorrectAnswers++;
                progress.level = 0; 
                const randomIndex = Math.min(session.queue.length, Math.floor(Math.random() * 3) + 2);
                session.queue.splice(randomIndex, 0, cardId);
            }
            
            const minutes_to_add = SRS_INTERVALS[progress.level];
            const newDueDate = new Date(Date.now() + minutes_to_add * 60000);
            progress.dueDate = newDueDate.toISOString();

            userProgress[cardId] = progress;
            saveUserProgress();
            nextCard();
        };

        const showSessionComplete = () => {
            document.getElementById('session-summary').textContent = 
                `คุณเรียนคำใหม่ไป ${session.newCardsStudied} คำ ตอบถูก ${session.correctAnswers} ครั้ง และตอบผิด ${session.incorrectAnswers} ครั้ง`;
            showView('sessionComplete');
        };

        // --- EVENT LISTENERS ---
        lineLoginBtn.addEventListener('click', () => {
            if (LIFF_ID === "YOUR_LIFF_ID_HERE") {
                // The error is already shown by initializeLiff, so just log it.
                console.error("Login button clicked but LIFF_ID is not set.");
                return;
            }
            liff.login();
        });

        startGameBtn.addEventListener('click', () => {
            showView('setup');
        });
        
        backToDashboardBtn.addEventListener('click', () => {
             showView('dashboard');
        });

        startSessionBtn.addEventListener('click', () => {
            const count = parseInt(cardCountInput.value, 10);
            if (count > 0 && count <= 50) {
                createSession(count);
            } else {
                alert("กรุณาใส่จำนวนคำระหว่าง 1 ถึง 50");
            }
        });

        flashcard.addEventListener('click', () => {
            if (flashcard.dataset.cardId) {
                flashcard.classList.toggle('flipped');
                answerButtons.classList.remove('hidden');
            }
        });

        rememberedBtn.addEventListener('click', () => handleAnswer(true));
        forgotBtn.addEventListener('click', () => handleAnswer(false));
        
        finishSessionBtn.addEventListener('click', () => {
            loadDataAndSetupDashboard();
        });

        // --- INITIALIZATION ---
        initializeLiff();
    });
    </script>
</body>
</html>


