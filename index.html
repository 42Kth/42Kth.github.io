<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle of Talingchan Deck Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .card-image {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border-radius: 12px;
            border: 2px solid transparent;
        }
        .card-image:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            cursor: grab;
        }
        .deck-slot {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            height: 100%;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative;
        }
        .deck-slot.drag-over {
            background-color: rgba(74, 222, 128, 0.2);
            border-color: #4ade80;
        }
        .deck-slot .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            border: 2px solid white;
        }
        .deck-slot:hover .remove-btn {
            opacity: 1;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.active {
            display: flex; /* Show when active */
        }
        #loading-state {
            display: none; /* Hide since data is loaded locally */
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Main container -->
    <div class="container mx-auto p-4 max-w-screen-2xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-yellow-400 tracking-wider">Battle of Talingchan</h1>
            <h2 class="text-2xl font-semibold text-gray-300">Deck Builder</h2>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[85vh]">
            <!-- Left Panel: Card Collection -->
            <div class="lg:col-span-2 bg-gray-800 rounded-2xl p-4 flex flex-col h-full shadow-lg">
                <div class="filters-container mb-4 p-4 bg-gray-900 rounded-lg shadow-inner">
                    <h3 class="text-xl font-semibold mb-3 text-yellow-300">ค้นหาการ์ด</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <input type="text" id="name-search" placeholder="ค้นหาชื่อการ์ด..." class="col-span-2 md:col-span-4 bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-yellow-500 focus:border-yellow-500">
                        <select id="type-filter" class="bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">ทุกประเภท</option>
                        </select>
                        <select id="color-filter" class="bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">ทุกสี</option>
                        </select>
                        <select id="cost-filter" class="bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">ทุกค่าร่าย</option>
                        </select>
                        <select id="tribe-filter" class="bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="">ทุกเผ่า</option>
                        </select>
                    </div>
                </div>
                <div id="card-gallery-wrapper" class="flex-grow relative">
                    <div id="card-gallery" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4 overflow-y-auto h-full p-2">
                        <!-- Cards will be injected here by JavaScript -->
                    </div>
                    <div id="loading-state">
                         <!-- Hidden by CSS -->
                    </div>
                </div>
            </div>

            <!-- Right Panel: Deck Builder -->
            <div class="bg-gray-800 rounded-2xl p-4 flex flex-col h-full shadow-lg">
                <div class="deck-header flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-yellow-300">เด็คของคุณ</h3>
                    <div class="text-lg font-semibold bg-gray-900 px-3 py-1 rounded-full">
                        <span id="deck-count">0</span> / 50
                    </div>
                </div>
                <div id="deck-slots" class="grid grid-cols-5 gap-2 overflow-y-auto flex-grow p-2 border-2 border-gray-700 rounded-lg">
                    <!-- 50 deck slots will be generated by JavaScript -->
                </div>
                <div class="deck-actions mt-4 grid grid-cols-2 gap-4">
                     <button id="view-collection-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        คอลเลคชั่นของฉัน
                    </button>
                    <button id="save-deck-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        บันทึกเด็ค
                    </button>
                    <button id="clear-deck-btn" class="col-span-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        ล้างเด็ค
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="save-deck-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-8 shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-yellow-300">ตั้งชื่อเด็ค</h2>
            <input type="text" id="deck-name-input" placeholder="ชื่อเด็คของคุณ..." class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 mb-4 focus:ring-yellow-500 focus:border-yellow-500">
            <div class="flex justify-end gap-4">
                <button id="cancel-save-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ยกเลิก</button>
                <button id="confirm-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">บันทึก</button>
            </div>
        </div>
    </div>

    <div id="collection-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-8 shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-300">คอลเลคชั่นเด็ค</h2>
                <button id="close-collection-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="deck-collection-list" class="overflow-y-auto space-y-3 pr-2">
                <!-- Saved decks will be listed here -->
            </div>
        </div>
    </div>
    
    <div id="card-tooltip" class="fixed p-2 bg-gray-900 border border-yellow-400 rounded-lg shadow-xl pointer-events-none opacity-0 transition-opacity z-50">
        <img id="tooltip-img" src="" class="w-64 rounded-md" alt="Card Preview">
    </div>

    <!-- Load Card Data First -->
    <script src="card-data.js"></script>

    <!-- Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const cardGallery = document.getElementById('card-gallery');
            const deckSlotsContainer = document.getElementById('deck-slots');
            const deckCountSpan = document.getElementById('deck-count');
            
            // Filters
            const nameSearch = document.getElementById('name-search');
            const typeFilter = document.getElementById('type-filter');
            const colorFilter = document.getElementById('color-filter');
            const costFilter = document.getElementById('cost-filter');
            const tribeFilter = document.getElementById('tribe-filter');
            
            // Buttons
            const saveDeckBtn = document.getElementById('save-deck-btn');
            const clearDeckBtn = document.getElementById('clear-deck-btn');
            const viewCollectionBtn = document.getElementById('view-collection-btn');

            // Modals
            const saveDeckModal = document.getElementById('save-deck-modal');
            const collectionModal = document.getElementById('collection-modal');
            const deckNameInput = document.getElementById('deck-name-input');
            const confirmSaveBtn = document.getElementById('confirm-save-btn');
            const cancelSaveBtn = document.getElementById('cancel-save-btn');
            const closeCollectionBtn = document.getElementById('close-collection-btn');
            const deckCollectionList = document.getElementById('deck-collection-list');
            
            // Tooltip
            const tooltip = document.getElementById('card-tooltip');
            const tooltipImg = document.getElementById('tooltip-img');

            // State
            let allCardData = [];
            let currentDeck = Array(50).fill(null);
            let draggedCardId = null;
            let draggedFromSlot = null;

            function initializeApp(cardData) {
                allCardData = cardData;
                populateFilters(cardData);
                renderCardGallery(cardData);
                createDeckSlots();
                updateDeckCount();
                
                [nameSearch, typeFilter, colorFilter, costFilter, tribeFilter].forEach(filter => {
                    filter.addEventListener('input', applyFilters);
                });

                clearDeckBtn.addEventListener('click', clearDeck);
                saveDeckBtn.addEventListener('click', () => {
                    if (currentDeck.filter(c => c).length === 0) {
                        alert("เด็คของคุณว่างเปล่า!");
                        return;
                    }
                    saveDeckModal.classList.add('active');
                    deckNameInput.focus();
                });
                cancelSaveBtn.addEventListener('click', () => saveDeckModal.classList.remove('active'));
                confirmSaveBtn.addEventListener('click', saveCurrentDeck);
                viewCollectionBtn.addEventListener('click', openCollectionModal);
                closeCollectionBtn.addEventListener('click', () => collectionModal.classList.remove('active'));
            }

            // --- Card Gallery and Filtering ---

            function populateFilters(cardData) {
                const types = [...new Set(cardData.map(c => c.type).filter(Boolean))];
                const colors = [...new Set(cardData.map(c => c.color).filter(Boolean))];
                const costs = [...new Set(cardData.map(c => c.cost).filter(Boolean))].sort((a,b) => Number(a) - Number(b));
                const tribes = [...new Set(cardData.map(c => c.tribe).filter(t => t && t !== '-'))];

                types.forEach(t => typeFilter.innerHTML += `<option value="${t}">${t}</option>`);
                colors.forEach(c => colorFilter.innerHTML += `<option value="${c}">${c}</option>`);
                costs.forEach(c => costFilter.innerHTML += `<option value="${c}">${c}</option>`);
                tribes.forEach(t => tribeFilter.innerHTML += `<option value="${t}">${t}</option>`);
            }
            
            function applyFilters() {
                let filteredCards = [...allCardData];
                const searchTerm = nameSearch.value.toLowerCase();

                if (searchTerm) {
                    filteredCards = filteredCards.filter(c => c.name.toLowerCase().includes(searchTerm));
                }
                if (typeFilter.value) filteredCards = filteredCards.filter(c => c.type === typeFilter.value);
                if (colorFilter.value) filteredCards = filteredCards.filter(c => c.color === colorFilter.value);
                if (costFilter.value) filteredCards = filteredCards.filter(c => c.cost == costFilter.value);
                if (tribeFilter.value) filteredCards = filteredCards.filter(c => c.tribe === tribeFilter.value);
                
                renderCardGallery(filteredCards);
            }

            function renderCardGallery(cards) {
                cardGallery.innerHTML = '';
                cards.forEach(card => {
                    const cardElement = document.createElement('div');
                    cardElement.innerHTML = `<img src="${card.imageUrl}" alt="${card.name}" class="card-image w-full h-full object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/200x280/1a202c/e2e8f0?text=No+Image';">`;
                    cardElement.draggable = true;
                    cardElement.dataset.cardId = card.id;
                    
                    cardElement.addEventListener('dragstart', handleDragStart);
                    cardElement.addEventListener('mouseenter', e => showTooltip(e, card.imageUrl));
                    cardElement.addEventListener('mouseleave', hideTooltip);
                    cardElement.addEventListener('mousemove', moveTooltip);
                    
                    cardGallery.appendChild(cardElement);
                });
            }

            // --- Deck Building ---

            function createDeckSlots() {
                for (let i = 0; i < 50; i++) {
                    const slot = document.createElement('div');
                    slot.classList.add('deck-slot');
                    slot.dataset.slotIndex = i;
                    slot.addEventListener('dragover', handleDragOver);
                    slot.addEventListener('dragleave', handleDragLeave);
                    slot.addEventListener('drop', handleDrop);
                    deckSlotsContainer.appendChild(slot);
                }
            }

            function updateDeckCount() {
                const count = currentDeck.filter(card => card !== null).length;
                deckCountSpan.textContent = count;
                deckCountSpan.parentElement.classList.toggle('text-green-400', count === 50);
                deckCountSpan.parentElement.classList.toggle('text-red-400', count < 50);
            }

            function renderDeck() {
                const slots = deckSlotsContainer.querySelectorAll('.deck-slot');
                slots.forEach((slot, index) => {
                    const card = currentDeck[index];
                    slot.innerHTML = '';
                    if (card) {
                        const img = document.createElement('img');
                        img.src = card.imageUrl;
                        img.alt = card.name;
                        img.classList.add('card-image');
                        img.draggable = true;
                        img.dataset.cardId = card.id;
                        img.addEventListener('dragstart', (e) => {
                            draggedFromSlot = index;
                            handleDragStart(e);
                        });
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.classList.add('remove-btn');
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = () => removeCardFromDeck(index);

                        slot.appendChild(img);
                        slot.appendChild(removeBtn);
                    }
                });
                updateDeckCount();
            }

            function removeCardFromDeck(index) {
                currentDeck[index] = null;
                renderDeck();
            }

            function clearDeck() {
                if(confirm("คุณแน่ใจหรือไม่ว่าต้องการล้างเด็คปัจจุบัน?")) {
                    currentDeck.fill(null);
                    renderDeck();
                }
            }
            
            // --- Drag and Drop Handlers ---
            
            function handleDragStart(e) {
                draggedCardId = e.target.dataset.cardId;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    if (draggedFromSlot !== null) {
                         e.target.parentElement.style.opacity = '0.5';
                    }
                }, 0);
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                e.currentTarget.classList.add('drag-over');
            }
            
            function handleDragLeave(e) {
                e.currentTarget.classList.remove('drag-over');
            }

            function handleDrop(e) {
                e.preventDefault();
                const targetSlot = e.currentTarget;
                targetSlot.classList.remove('drag-over');
                
                if (!draggedCardId) return;

                const card = allCardData.find(c => c.id === draggedCardId);
                const targetIndex = parseInt(targetSlot.dataset.slotIndex);

                if (draggedFromSlot !== null) { // Reordering
                    const sourceCard = currentDeck[draggedFromSlot];
                    const targetCard = currentDeck[targetIndex];
                    currentDeck[targetIndex] = sourceCard;
                    currentDeck[draggedFromSlot] = targetCard;
                } else { // Adding new card
                    currentDeck[targetIndex] = card;
                }

                draggedCardId = null;
                draggedFromSlot = null;
                renderDeck();
            }
            
            // --- Saving and Loading Decks ---

            function getSavedDecks() {
                return JSON.parse(localStorage.getItem('bot_decks_v2') || '{}');
            }

            function saveCurrentDeck() {
                const deckName = deckNameInput.value.trim();
                if (!deckName) {
                    alert('กรุณาตั้งชื่อเด็ค!');
                    return;
                }
                const decks = getSavedDecks();
                decks[deckName] = currentDeck.filter(c => c).map(c => c.id); // Save only card IDs
                localStorage.setItem('bot_decks_v2', JSON.stringify(decks));
                saveDeckModal.classList.remove('active');
                deckNameInput.value = '';
                alert(`บันทึกเด็ค "${deckName}" สำเร็จ!`);
            }

            function openCollectionModal() {
                const decks = getSavedDecks();
                deckCollectionList.innerHTML = '';

                if (Object.keys(decks).length === 0) {
                    deckCollectionList.innerHTML = '<p class="text-gray-400 text-center">ยังไม่มีเด็คที่บันทึกไว้</p>';
                } else {
                    for (const deckName in decks) {
                        const deckIds = decks[deckName];
                        const deckItem = document.createElement('div');
                        deckItem.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center hover:bg-gray-600 transition-colors';
                        deckItem.innerHTML = `
                            <div>
                                <h4 class="font-semibold text-lg">${deckName}</h4>
                                <p class="text-sm text-gray-400">${deckIds.length} การ์ด</p>
                            </div>
                            <div class="space-x-2">
                                <button data-deck-name="${deckName}" class="load-btn bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded">โหลด</button>
                                <button data-deck-name="${deckName}" class="delete-btn bg-red-500 hover:bg-red-600 px-3 py-1 rounded">ลบ</button>
                            </div>
                        `;
                        deckCollectionList.appendChild(deckItem);
                    }
                }
                
                collectionModal.classList.add('active');
                deckCollectionList.querySelectorAll('.load-btn').forEach(btn => btn.addEventListener('click', loadDeck));
                deckCollectionList.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', deleteDeck));
            }

            function loadDeck(e) {
                const deckName = e.target.dataset.deckName;
                if (!confirm(`คุณต้องการโหลดเด็ค "${deckName}" หรือไม่? เด็คปัจจุบันจะถูกล้าง`)) return;
                
                const decks = getSavedDecks();
                const deckIdsToLoad = decks[deckName];
                
                currentDeck.fill(null);
                deckIdsToLoad.forEach((cardId, index) => {
                    const cardObject = allCardData.find(c => c.id === cardId);
                    if (cardObject) {
                        currentDeck[index] = cardObject;
                    }
                });

                renderDeck();
                collectionModal.classList.remove('active');
            }

            function deleteDeck(e) {
                const deckName = e.target.dataset.deckName;
                if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบเด็ค "${deckName}"?`)) return;
                const decks = getSavedDecks();
                delete decks[deckName];
                localStorage.setItem('bot_decks_v2', JSON.stringify(decks));
                openCollectionModal();
            }

            // --- Tooltip ---
            function showTooltip(event, imageUrl) {
                tooltipImg.src = imageUrl;
                tooltip.style.opacity = '1';
            }
            function hideTooltip() {
                tooltip.style.opacity = '0';
            }
            function moveTooltip(event) {
                let x = event.clientX + 20;
                let y = event.clientY + 20;
                if (x + tooltip.offsetWidth > window.innerWidth) x = event.clientX - tooltip.offsetWidth - 20;
                if (y + tooltip.offsetHeight > window.innerHeight) y = window.innerHeight - tooltip.offsetHeight - 10;
                tooltip.style.left = `${x}px`;
                tooltip.style.top = `${y}px`;
            }

            // --- Start the App ---
            // `cardDatabase` is now globally available from `card-data.js`
            if (typeof cardDatabase !== 'undefined' && cardDatabase.length > 0) {
                initializeApp(cardDatabase);
            } else {
                console.error("Card data is not loaded. Ensure card-data.js is in the same directory.");
                document.getElementById('card-gallery-wrapper').innerHTML = `<p class="text-red-500 text-center p-4">ไม่พบข้อมูลการ์ด! กรุณาตรวจสอบว่าไฟล์ card-data.js อยู่ในโฟลเดอร์เดียวกันกับไฟล์ index.html</p>`;
            }
        });
    </script>
</body>
</html>

